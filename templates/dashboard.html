{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Oversigt - Budget{% endblock %}

{% block content %}
<div class="max-w-md mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Budget</h1>
        <div class="flex items-center gap-3">
            <!-- Period Toggle -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                <button
                    id="btn-monthly"
                    onclick="setPeriod('monthly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                >
                    Måned
                </button>
                <button
                    id="btn-yearly"
                    onclick="setPeriod('yearly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400"
                >
                    År
                </button>
            </div>
            <a href="/budget/logout" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 gap-3 mb-6">
        <!-- Income -->
        <a href="/budget/income" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-success"></i>
                    Indkomst
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_income }}" data-yearly="{{ total_income * 12 }}">{{ format_currency(total_income) }}</div>
        </a>

        <!-- Expenses -->
        <a href="/budget/expenses" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-down" class="w-4 h-4 text-danger"></i>
                    Udgifter
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_expenses }}" data-yearly="{{ total_expenses * 12 }}">{{ format_currency(total_expenses) }}</div>
        </a>
    </div>

    <!-- Remaining (Featured) -->
    <div class="bg-gradient-to-r {% if remaining >= 0 %}from-emerald-500 to-green-600{% else %}from-red-500 to-rose-600{% endif %} rounded-2xl p-6 mb-6 text-white shadow-lg">
        <div class="text-sm opacity-90 mb-1">Til fri brug<span class="period-suffix">/md</span></div>
        <div class="text-3xl font-bold" data-monthly="{{ remaining }}" data-yearly="{{ remaining * 12 }}">{{ format_currency(remaining) }}</div>
        <div class="text-sm opacity-75 mt-2">
            {% if remaining >= 0 %}
            {{ "%.0f"|format((remaining / total_income * 100) if total_income > 0 else 0) }}% af indkomst
            {% else %}
            Underskud!
            {% endif %}
        </div>
    </div>

    <!-- Expense Breakdown -->
    {% if expenses_by_category %}
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Udgifter per kategori</h2>
    <div class="space-y-3">
        {% for category, expenses in expenses_by_category.items() %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="font-medium text-gray-900 dark:text-white">{{ category }}</div>
                <div class="text-gray-600 dark:text-gray-300">
                    <span data-monthly="{{ category_totals[category] }}" data-yearly="{{ category_totals[category] * 12 }}">{{ format_currency(category_totals[category]) }}</span><span class="period-suffix">/md</span>
                </div>
            </div>

            <!-- Individual expenses -->
            <div class="space-y-2">
                {% for expense in expenses %}
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">{{ expense.name }}</span>
                    <span class="text-gray-900 dark:text-gray-200">
                        <span data-monthly="{{ expense.monthly_amount }}" data-yearly="{{ expense.monthly_amount * 12 }}">{{ format_currency(expense.monthly_amount) }}</span>
                        {% if expense.frequency != 'monthly' %}
                        <span class="text-gray-400 dark:text-gray-500 text-xs original-frequency">({{ format_currency(expense.amount) }}/{% if expense.frequency == 'yearly' %}år{% elif expense.frequency == 'quarterly' %}kvartal{% elif expense.frequency == 'semi-annual' %}halvår{% endif %})</span>
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty state -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="receipt" class="w-6 h-6 text-gray-400"></i>
        </div>
        <h3 class="font-medium text-gray-900 dark:text-white mb-1">Ingen udgifter endnu</h3>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Tilføj dine faste udgifter for at få et overblik</p>
        <a href="/budget/expenses" class="inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
            Tilføj udgifter
        </a>
    </div>
    {% endif %}

    <!-- Income breakdown (small) -->
    <a href="/budget/income" class="block mt-6 bg-gray-100 dark:bg-gray-800 rounded-xl p-4 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors group">
        <div class="flex justify-between items-center mb-2">
            <div class="text-sm text-gray-500 dark:text-gray-400">Indkomst fordeling</div>
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
        </div>
        <div class="flex justify-between text-sm">
            {% for income in incomes %}
            <div>
                <span class="text-gray-600 dark:text-gray-400">{{ income.person }}:</span>
                <span class="font-medium text-gray-900 dark:text-white" data-monthly="{{ income.monthly_amount }}" data-yearly="{{ income.monthly_amount * 12 }}">{{ format_currency(income.monthly_amount) }}</span>
            </div>
            {% endfor %}
        </div>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(amount) {
        return new Intl.NumberFormat('da-DK', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(Math.round(amount)) + ' kr';
    }

    function setPeriod(period) {
        const btnMonthly = document.getElementById('btn-monthly');
        const btnYearly = document.getElementById('btn-yearly');
        const suffixes = document.querySelectorAll('.period-suffix');
        const originalFrequencies = document.querySelectorAll('.original-frequency');

        // Update button styles
        if (period === 'monthly') {
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        } else {
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        }

        // Update all values with data attributes
        document.querySelectorAll('[data-monthly]').forEach(el => {
            const value = parseFloat(el.dataset[period]);
            el.textContent = formatCurrency(value);
        });

        // Update period suffixes
        suffixes.forEach(el => {
            el.textContent = period === 'monthly' ? '/md' : '/år';
        });

        // Hide/show original frequency annotations in yearly view
        originalFrequencies.forEach(el => {
            el.style.display = period === 'yearly' ? 'none' : '';
        });

        // Save preference
        localStorage.setItem('budgetPeriod', period);
    }

    // Restore saved preference on load
    document.addEventListener('DOMContentLoaded', () => {
        const savedPeriod = localStorage.getItem('budgetPeriod');
        if (savedPeriod === 'yearly') {
            setPeriod('yearly');
        }
    });
</script>
{% endblock %}
