{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Oversigt - Budget{% endblock %}

{% block content %}

<div class="max-w-md mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Budget</h1>
        <div class="flex items-center gap-3">
            <!-- Period Toggle -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                <button
                    id="btn-monthly"
                    onclick="setPeriod('monthly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                >
                    Måned
                </button>
                <button
                    id="btn-yearly"
                    onclick="setPeriod('yearly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400"
                >
                    År
                </button>
            </div>
            <a href="/budget/logout" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 gap-3 mb-6">
        <!-- Income -->
        <a href="/budget/income" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-success"></i>
                    Indkomst
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_income }}" data-yearly="{{ total_income * 12 }}">{{ format_currency(total_income) }}</div>
        </a>

        <!-- Expenses -->
        <a href="/budget/expenses" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-down" class="w-4 h-4 text-danger"></i>
                    Udgifter
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_expenses }}" data-yearly="{{ total_expenses * 12 }}">{{ format_currency(total_expenses) }}</div>
        </a>
    </div>

    <!-- Remaining (Featured) -->
    <div class="bg-gradient-to-r {% if remaining >= 0 %}from-emerald-500 to-green-600{% else %}from-red-500 to-rose-600{% endif %} rounded-2xl p-6 mb-6 text-white shadow-lg">
        <div class="text-sm opacity-90 mb-1">Til fri brug<span class="period-suffix">/md</span></div>
        <div class="text-3xl font-bold" data-monthly="{{ remaining }}" data-yearly="{{ remaining * 12 }}">{{ format_currency(remaining) }}</div>
        <div class="text-sm opacity-75 mt-2">
            {% if remaining >= 0 %}
            {{ "%.0f"|format((remaining / total_income * 100) if total_income > 0 else 0) }}% af indkomst
            {% else %}
            Underskud!
            {% endif %}
        </div>
    </div>

    <!-- Transfer Summary (Overførselsoversigt) -->
    {% if account_totals %}
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-sm font-medium text-gray-600 dark:text-gray-400">Overførselsoversigt</h2>
            <a href="/budget/accounts" class="text-xs text-primary hover:text-blue-600 flex items-center gap-1">
                Administrer
                <i data-lucide="chevron-right" class="w-3 h-3"></i>
            </a>
        </div>
        <div class="space-y-2">
            {% for account_name, total in account_totals.items() %}
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i data-lucide="landmark" class="w-4 h-4 text-gray-400"></i>
                    <span class="text-gray-700 dark:text-gray-300">{{ account_name }}</span>
                </div>
                <span class="font-medium text-gray-900 dark:text-white">
                    <span data-monthly="{{ total }}" data-yearly="{{ total * 12 }}">{{ format_currency(total) }}</span><span class="period-suffix">/md</span>
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Expense Breakdown -->
    {% if expenses_by_category %}
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Udgifter per kategori</h2>
        <div class="flex items-center gap-2">
            <!-- Sort dropdown (from master) -->
            <select
                id="category-sort"
                onchange="sortCategories(this.value)"
                class="text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-lg border-0 focus:ring-2 focus:ring-primary outline-none cursor-pointer"
            >
                <option value="amount-desc">Højeste først</option>
                <option value="amount-asc">Laveste først</option>
                <option value="name-asc">A-Å</option>
                <option value="name-desc">Å-A</option>
            </select>
            <!-- Collapse toggle (from feature branch) -->
            <button
                id="toggle-all-btn"
                onclick="toggleAllCategories()"
                class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 flex items-center gap-1 transition-colors"
            >
                <i data-lucide="chevrons-down" id="toggle-all-icon" class="w-4 h-4"></i>
                <span id="toggle-all-text">Fold ind</span>
            </button>
        </div>
    </div>
    <div id="category-list" class="space-y-3">
        {% for category, expenses in expenses_by_category.items() %}
        <div class="category-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden" data-category="{{ category }}" data-amount="{{ category_totals[category] }}">
            <!-- Category header (clickable for collapse) -->
            <button
                onclick="toggleCategory('{{ category|replace(' ', '-') }}')"
                class="w-full px-4 py-3 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
            >
                <div class="flex items-center gap-2">
                    <i data-lucide="chevron-down" id="chevron-{{ category|replace(' ', '-') }}" class="w-4 h-4 text-gray-400 transition-transform"></i>
                    <span class="font-medium text-gray-900 dark:text-white">{{ category }}</span>
                </div>
                <div class="text-gray-600 dark:text-gray-300">
                    <span data-monthly="{{ category_totals[category] }}" data-yearly="{{ category_totals[category] * 12 }}">{{ format_currency(category_totals[category]) }}</span><span class="period-suffix">/md</span>
                </div>
            </button>

            <!-- Individual expenses (collapsible) -->
            <div id="cat-{{ category|replace(' ', '-') }}" class="border-t border-gray-100 dark:border-gray-700 px-4 py-2 space-y-2">
                {% for expense in expenses %}
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">{{ expense.name }}</span>
                    <span class="text-gray-900 dark:text-gray-200">
                        <span data-monthly="{{ expense.monthly_amount }}" data-yearly="{{ expense.monthly_amount * 12 }}">{{ format_currency(expense.monthly_amount) }}</span>
                        {% if expense.frequency != 'monthly' %}
                        <span class="text-gray-400 dark:text-gray-500 text-xs original-frequency">({{ format_currency(expense.amount) }}/{% if expense.frequency == 'yearly' %}år{% elif expense.frequency == 'quarterly' %}kvartal{% elif expense.frequency == 'semi-annual' %}halvår{% endif %})</span>
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty state -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="receipt" class="w-6 h-6 text-gray-400"></i>
        </div>
        <h3 class="font-medium text-gray-900 dark:text-white mb-1">Ingen udgifter endnu</h3>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Tilføj dine faste udgifter for at få et overblik</p>
        <a href="/budget/expenses" class="inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
            Tilføj udgifter
        </a>
    </div>
    {% endif %}

    <!-- Income breakdown (small) -->
    <a href="/budget/income" class="block mt-6 bg-gray-100 dark:bg-gray-800 rounded-xl p-4 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors group">
        <div class="flex justify-between items-center mb-2">
            <div class="text-sm text-gray-500 dark:text-gray-400">Indkomst fordeling</div>
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
        </div>
        <div class="flex justify-between text-sm">
            {% for income in incomes %}
            <div>
                <span class="text-gray-600 dark:text-gray-400">{{ income.person }}:</span>
                <span class="font-medium text-gray-900 dark:text-white" data-monthly="{{ income.monthly_amount }}" data-yearly="{{ income.monthly_amount * 12 }}">{{ format_currency(income.monthly_amount) }}</span>
            </div>
            {% endfor %}
        </div>
    </a>

    <!-- Category Pie Chart -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3">Udgiftsfordeling</h3>
        <div class="h-64">
            <canvas id="chart-categories"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // === Currency formatting ===
    function formatCurrency(amount) {
        return new Intl.NumberFormat('da-DK', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount) + ' kr';
    }

    // === Period toggle (monthly/yearly) ===
    function setPeriod(period) {
        const btnMonthly = document.getElementById('btn-monthly');
        const btnYearly = document.getElementById('btn-yearly');
        const suffixes = document.querySelectorAll('.period-suffix');
        const originalFrequencies = document.querySelectorAll('.original-frequency');

        // Update button styles
        if (period === 'monthly') {
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        } else {
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        }

        // Update all values with data attributes
        document.querySelectorAll('[data-monthly]').forEach(el => {
            const value = parseFloat(el.dataset[period]);
            el.textContent = formatCurrency(value);
        });

        // Update period suffixes
        suffixes.forEach(el => {
            el.textContent = period === 'monthly' ? '/md' : '/år';
        });

        // Hide/show original frequency annotations in yearly view
        originalFrequencies.forEach(el => {
            el.style.display = period === 'yearly' ? 'none' : '';
        });

        // Save preference
        localStorage.setItem('budgetPeriod', period);
    }

    // === Category sorting (from master) ===
    function sortCategories(sortBy) {
        const container = document.getElementById('category-list');
        if (!container) return;

        const cards = Array.from(container.querySelectorAll('.category-card'));

        cards.sort((a, b) => {
            const nameA = a.dataset.category;
            const nameB = b.dataset.category;
            const amountA = parseFloat(a.dataset.amount);
            const amountB = parseFloat(b.dataset.amount);

            switch (sortBy) {
                case 'amount-desc':
                    return amountB - amountA;
                case 'amount-asc':
                    return amountA - amountB;
                case 'name-asc':
                    return nameA.localeCompare(nameB, 'da');
                case 'name-desc':
                    return nameB.localeCompare(nameA, 'da');
                default:
                    return 0;
            }
        });

        // Re-append sorted cards
        cards.forEach(card => container.appendChild(card));

        // Save preference
        localStorage.setItem('categorySortOrder', sortBy);
    }

    // === Category collapse/expand (from feature branch) ===
    let allCollapsed = false;

    function toggleCategory(categoryId) {
        const content = document.getElementById('cat-' + categoryId);
        const chevron = document.getElementById('chevron-' + categoryId);

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(-90deg)';
        }
        updateToggleAllButton();
    }

    function toggleAllCategories() {
        const contents = document.querySelectorAll('[id^="cat-"]');
        const chevrons = document.querySelectorAll('[id^="chevron-"]');

        if (allCollapsed) {
            contents.forEach(c => c.classList.remove('hidden'));
            chevrons.forEach(c => c.style.transform = 'rotate(0deg)');
        } else {
            contents.forEach(c => c.classList.add('hidden'));
            chevrons.forEach(c => c.style.transform = 'rotate(-90deg)');
        }
        allCollapsed = !allCollapsed;
        updateToggleAllButton();
    }

    function updateToggleAllButton() {
        const contents = document.querySelectorAll('[id^="cat-"]');
        const hiddenCount = Array.from(contents).filter(c => c.classList.contains('hidden')).length;
        const toggleText = document.getElementById('toggle-all-text');
        const toggleIcon = document.getElementById('toggle-all-icon');

        if (hiddenCount === contents.length) {
            allCollapsed = true;
            toggleText.textContent = 'Fold ud';
            toggleIcon.setAttribute('data-lucide', 'chevrons-up');
        } else {
            allCollapsed = false;
            toggleText.textContent = 'Fold ind';
            toggleIcon.setAttribute('data-lucide', 'chevrons-down');
        }
        lucide.createIcons();
    }

    // === Restore saved preferences on load ===
    document.addEventListener('DOMContentLoaded', () => {
        // Restore period preference
        const savedPeriod = localStorage.getItem('budgetPeriod');
        if (savedPeriod === 'yearly') {
            setPeriod('yearly');
        }

        // Restore sort preference
        const savedSort = localStorage.getItem('categorySortOrder');
        if (savedSort) {
            const select = document.getElementById('category-sort');
            if (select) {
                select.value = savedSort;
                sortCategories(savedSort);
            }
        }

        // Initialize charts
        initCharts();
    });

    // === Chart Visualization ===
    let categoryChart = null;

    // Color palette for charts (matches TailwindCSS colors)
    const chartColors = [
        '#3b82f6', // blue-500
        '#10b981', // emerald-500
        '#f59e0b', // amber-500
        '#ef4444', // red-500
        '#8b5cf6', // violet-500
        '#ec4899', // pink-500
        '#06b6d4', // cyan-500
        '#84cc16', // lime-500
    ];

    async function initCharts() {
        try {
            const response = await fetch('/budget/api/chart-data');
            if (!response.ok) return;

            const data = await response.json();
            renderCategoryChart(data.category_totals);
        } catch (error) {
            console.error('Failed to load chart data:', error);
        }
    }

    function renderCategoryChart(categoryTotals) {
        const ctx = document.getElementById('chart-categories');
        if (!ctx) return;

        const labels = Object.keys(categoryTotals);
        const values = Object.values(categoryTotals);
        const total = values.reduce((a, b) => a + b, 0);

        // Skip if no data
        if (total === 0) {
            ctx.parentElement.innerHTML = '<p class="text-gray-400 text-center py-8">Ingen data</p>';
            return;
        }

        if (categoryChart) categoryChart.destroy();

        categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: chartColors.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563',
                            padding: 12,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
