{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Oversigt - Budget{% endblock %}

{% block content %}

<div class="max-w-md mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Budget</h1>
        <div class="flex items-center gap-3">
            <!-- Period Toggle -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                <button
                    id="btn-monthly"
                    onclick="setPeriod('monthly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                >
                    Måned
                </button>
                <button
                    id="btn-yearly"
                    onclick="setPeriod('yearly')"
                    class="px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400"
                >
                    År
                </button>
            </div>
            <a href="/budget/logout" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 gap-3 mb-6">
        <!-- Income -->
        <a href="/budget/income" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-success"></i>
                    Indkomst
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_income }}" data-yearly="{{ total_income * 12 }}">{{ format_currency(total_income) }}</div>
        </a>

        <!-- Expenses -->
        <a href="/budget/expenses" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors group">
            <div class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-sm mb-1">
                <div class="flex items-center gap-2">
                    <i data-lucide="trending-down" class="w-4 h-4 text-danger"></i>
                    Udgifter
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <div class="text-lg font-bold text-gray-900 dark:text-white" data-monthly="{{ total_expenses }}" data-yearly="{{ total_expenses * 12 }}">{{ format_currency(total_expenses) }}</div>
        </a>
    </div>

    <!-- Remaining (Featured) -->
    <div class="bg-gradient-to-r {% if remaining >= 0 %}from-emerald-500 to-green-600{% else %}from-red-500 to-rose-600{% endif %} rounded-2xl p-6 mb-6 text-white shadow-lg">
        <div class="text-sm opacity-90 mb-1">Til fri brug<span class="period-suffix">/md</span></div>
        <div class="text-3xl font-bold" data-monthly="{{ remaining }}" data-yearly="{{ remaining * 12 }}">{{ format_currency(remaining) }}</div>
        <div class="text-sm opacity-75 mt-2">
            {% if remaining >= 0 %}
            {{ "%.0f"|format((remaining / total_income * 100) if total_income > 0 else 0) }}% af indkomst
            {% else %}
            Underskud!
            {% endif %}
        </div>
    </div>

    <!-- Sortable Sections Container -->
    <div id="sortable-sections">
        <!-- Expense Breakdown -->
        <div data-section-id="expenses-breakdown">
        {% if expenses_by_category %}
        <div class="group/section">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-1">
                    <div class="drag-handle cursor-grab active:cursor-grabbing opacity-0 group-hover/section:opacity-100 transition-opacity p-1 -ml-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Udgifter per kategori</h2>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Sort dropdown -->
                    <select
                        id="category-sort"
                        onchange="sortCategories(this.value)"
                        class="text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-lg border-0 focus:ring-2 focus:ring-primary outline-none cursor-pointer"
                    >
                        <option value="name-asc">A-Å</option>
                        <option value="name-desc">Å-A</option>
                        <option value="amount-desc">Højeste først</option>
                        <option value="amount-asc">Laveste først</option>
                    </select>
                    <!-- Collapse toggle -->
                    <button
                        id="toggle-all-btn"
                        onclick="toggleAllCategories()"
                        class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 flex items-center gap-1 transition-colors"
                    >
                        <i data-lucide="chevrons-down" id="toggle-all-icon" class="w-4 h-4"></i>
                        <span id="toggle-all-text">Fold ind</span>
                    </button>
                </div>
            </div>
            <div id="category-list" class="space-y-3">
                {% for category, expenses in expenses_by_category.items() %}
                <div class="category-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden" data-category="{{ category }}" data-amount="{{ category_totals[category] }}">
                    <!-- Category header (clickable for collapse) -->
                    <button
                        onclick="toggleCategory('{{ category|replace(' ', '-') }}')"
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                    >
                        <div class="flex items-center gap-2">
                            <i data-lucide="chevron-down" id="chevron-{{ category|replace(' ', '-') }}" class="w-4 h-4 text-gray-400 transition-transform"></i>
                            <span class="font-medium text-gray-900 dark:text-white">{{ category }}</span>
                        </div>
                        <div class="text-gray-600 dark:text-gray-300">
                            <span data-monthly="{{ category_totals[category] }}" data-yearly="{{ category_totals[category] * 12 }}">{{ format_currency(category_totals[category]) }}</span><span class="period-suffix">/md</span>
                        </div>
                    </button>

                    <!-- Individual expenses (collapsible) -->
                    <div id="cat-{{ category|replace(' ', '-') }}" class="border-t border-gray-100 dark:border-gray-700 px-4 py-2 space-y-2">
                        {% for expense in expenses %}
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">{{ expense.name }}</span>
                            <span class="text-gray-900 dark:text-gray-200">
                                <span data-monthly="{{ expense.monthly_amount }}" data-yearly="{{ expense.monthly_amount * 12 }}">{{ format_currency(expense.monthly_amount) }}</span>
                                {% if expense.frequency != 'monthly' %}
                                <span class="text-gray-400 dark:text-gray-500 text-xs original-frequency">({{ format_currency(expense.amount) }}/{% if expense.frequency == 'yearly' %}år{% elif expense.frequency == 'quarterly' %}kvartal{% elif expense.frequency == 'semi-annual' %}halvår{% endif %})</span>
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <!-- Empty state -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="receipt" class="w-6 h-6 text-gray-400"></i>
            </div>
            <h3 class="font-medium text-gray-900 dark:text-white mb-1">Ingen udgifter endnu</h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Tilføj dine faste udgifter for at få et overblik</p>
            <a href="/budget/expenses" class="inline-block bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                Tilføj udgifter
            </a>
        </div>
        {% endif %}
        </div>

        <!-- Transfer Summary (Overførselsoversigt) -->
        <div data-section-id="transfer-summary">
        {% if account_totals %}
        <div class="group/section mt-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-1">
                        <div class="drag-handle cursor-grab active:cursor-grabbing opacity-0 group-hover/section:opacity-100 transition-opacity p-1 -ml-2">
                            <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <h2 class="text-sm font-medium text-gray-600 dark:text-gray-400">Overførselsoversigt</h2>
                    </div>
                    <a href="/budget/accounts" class="text-xs text-primary hover:text-blue-600 flex items-center gap-1">
                        Administrer
                        <i data-lucide="chevron-right" class="w-3 h-3"></i>
                    </a>
                </div>
                <div class="space-y-2">
                    {% for account_name, total in account_totals.items() %}
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i data-lucide="landmark" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-gray-700 dark:text-gray-300">{{ account_name }}</span>
                        </div>
                        <span class="font-medium text-gray-900 dark:text-white">
                            <span data-monthly="{{ total }}" data-yearly="{{ total * 12 }}">{{ format_currency(total) }}</span><span class="period-suffix">/md</span>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        </div>

        <!-- Income breakdown (small) -->
        <div data-section-id="income-breakdown">
        <div class="group/section mt-6">
            <a href="/budget/income" class="block bg-gray-100 dark:bg-gray-800 rounded-xl p-4 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors group">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-1">
                        <div class="drag-handle cursor-grab active:cursor-grabbing opacity-0 group-hover/section:opacity-100 transition-opacity p-1 -ml-2" onclick="event.preventDefault(); event.stopPropagation();">
                            <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Indkomst fordeling</div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
                <div class="flex justify-between text-sm">
                    {% for income in incomes %}
                    <div>
                        <span class="text-gray-600 dark:text-gray-400">{{ income.person }}:</span>
                        <span class="font-medium text-gray-900 dark:text-white" data-monthly="{{ income.monthly_amount }}" data-yearly="{{ income.monthly_amount * 12 }}">{{ format_currency(income.monthly_amount) }}</span>
                    </div>
                    {% endfor %}
                </div>
            </a>
        </div>
        </div>

        <!-- Category Pie Chart -->
        <div data-section-id="category-chart">
        <div class="group/section mt-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-1 mb-3">
                    <div class="drag-handle cursor-grab active:cursor-grabbing opacity-0 group-hover/section:opacity-100 transition-opacity p-1 -ml-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Udgiftsfordeling</h3>
                </div>
                <div class="h-64">
                    <canvas id="chart-categories"></canvas>
                </div>
            </div>
        </div>
        </div>

        <!-- Yearly Overview Table -->
        <div data-section-id="yearly-overview">
        <div class="group/section mt-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div class="flex items-center gap-1 px-4 pt-4 pb-2">
                    <div class="drag-handle cursor-grab active:cursor-grabbing opacity-0 group-hover/section:opacity-100 transition-opacity p-1 -ml-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Årsoverblik</h3>
                </div>
                {% if yearly_overview.categories %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="sticky left-0 bg-white dark:bg-gray-800 text-left px-4 py-2 font-semibold text-gray-900 dark:text-white z-10">Kategori</th>
                                {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'] %}
                                {% for name in month_names %}
                                <th class="text-right px-3 py-2 font-semibold text-gray-900 dark:text-white whitespace-nowrap">{{ name }}</th>
                                {% endfor %}
                                <th class="text-right px-4 py-2 font-semibold text-gray-900 dark:text-white whitespace-nowrap">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cat_name, months in yearly_overview.categories.items() %}
                            <tr class="border-b border-gray-100 dark:border-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                <td class="sticky left-0 bg-white dark:bg-gray-800 px-4 py-2 font-medium text-gray-900 dark:text-white z-10">{{ cat_name }}</td>
                                {% for m in range(1, 13) %}
                                <td class="text-right px-3 py-2 tabular-nums {% if months[m] == 0 %}text-gray-300 dark:text-gray-600{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                    {{ format_currency_short(months[m]) }}
                                </td>
                                {% endfor %}
                                <td class="text-right px-4 py-2 font-medium tabular-nums text-gray-900 dark:text-white">
                                    {{ format_currency_short(months.values() | sum) }}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="border-t-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50">
                                <td class="sticky left-0 bg-gray-50 dark:bg-gray-700/50 px-4 py-2 font-semibold text-gray-900 dark:text-white z-10">Udgifter i alt</td>
                                {% for m in range(1, 13) %}
                                <td class="text-right px-3 py-2 font-semibold tabular-nums text-gray-900 dark:text-white">
                                    {{ format_currency_short(yearly_overview.totals[m]) }}
                                </td>
                                {% endfor %}
                                <td class="text-right px-4 py-2 font-bold tabular-nums text-gray-900 dark:text-white">
                                    {{ format_currency_short(yearly_overview.year_total) }}
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                <td class="sticky left-0 bg-white dark:bg-gray-800 px-4 py-2 font-medium text-green-600 dark:text-green-400 z-10">Indkomst</td>
                                {% for m in range(1, 13) %}
                                <td class="text-right px-3 py-2 tabular-nums text-green-600 dark:text-green-400">
                                    {{ format_currency_short(yearly_overview.income[m]) }}
                                </td>
                                {% endfor %}
                                <td class="text-right px-4 py-2 font-medium tabular-nums text-green-600 dark:text-green-400">
                                    {{ format_currency_short(yearly_overview.income.values() | sum) }}
                                </td>
                            </tr>
                            <tr class="border-t-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50">
                                <td class="sticky left-0 bg-gray-50 dark:bg-gray-700/50 px-4 py-2 font-bold text-gray-900 dark:text-white z-10">Balance</td>
                                {% for m in range(1, 13) %}
                                <td class="text-right px-3 py-2 font-bold tabular-nums {% if yearly_overview.balance[m] >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                    {{ format_currency_short(yearly_overview.balance[m]) }}
                                </td>
                                {% endfor %}
                                {% set year_balance = yearly_overview.balance.values() | sum %}
                                <td class="text-right px-4 py-2 font-bold tabular-nums {% if year_balance >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                    {{ format_currency_short(year_balance) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-400 dark:text-gray-500 text-center py-6 text-sm">Ingen udgifter endnu.</p>
                {% endif %}
            </div>
        </div>
        </div>
    </div>

    <!-- Reset order button -->
    <div id="reset-order-container" class="mt-3 text-center hidden">
        <button onclick="resetSectionOrder()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
            <i data-lucide="rotate-ccw" class="w-3 h-3 inline mr-1"></i>Nulstil rækkefølge
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // === Currency formatting ===
    function formatCurrency(amount) {
        return new Intl.NumberFormat('da-DK', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount) + ' kr';
    }

    // === Period toggle (monthly/yearly) ===
    function setPeriod(period) {
        const btnMonthly = document.getElementById('btn-monthly');
        const btnYearly = document.getElementById('btn-yearly');
        const suffixes = document.querySelectorAll('.period-suffix');
        const originalFrequencies = document.querySelectorAll('.original-frequency');

        // Update button styles
        if (period === 'monthly') {
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        } else {
            btnYearly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
            btnMonthly.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400';
        }

        // Update all values with data attributes
        document.querySelectorAll('[data-monthly]').forEach(el => {
            const value = parseFloat(el.dataset[period]);
            el.textContent = formatCurrency(value);
        });

        // Update period suffixes
        suffixes.forEach(el => {
            el.textContent = period === 'monthly' ? '/md' : '/år';
        });

        // Hide/show original frequency annotations in yearly view
        originalFrequencies.forEach(el => {
            el.style.display = period === 'yearly' ? 'none' : '';
        });

        // Save preference
        localStorage.setItem('budgetPeriod', period);
    }

    // === Category sorting (from master) ===
    function sortCategories(sortBy) {
        const container = document.getElementById('category-list');
        if (!container) return;

        const cards = Array.from(container.querySelectorAll('.category-card'));

        cards.sort((a, b) => {
            const nameA = a.dataset.category;
            const nameB = b.dataset.category;
            const amountA = parseFloat(a.dataset.amount);
            const amountB = parseFloat(b.dataset.amount);

            switch (sortBy) {
                case 'amount-desc':
                    return amountB - amountA;
                case 'amount-asc':
                    return amountA - amountB;
                case 'name-asc':
                    return nameA.localeCompare(nameB, 'da');
                case 'name-desc':
                    return nameB.localeCompare(nameA, 'da');
                default:
                    return 0;
            }
        });

        // Re-append sorted cards
        cards.forEach(card => container.appendChild(card));

        // Save preference
        localStorage.setItem('categorySortOrder', sortBy);
    }

    // === Category collapse/expand (from feature branch) ===
    let allCollapsed = false;

    function toggleCategory(categoryId) {
        const content = document.getElementById('cat-' + categoryId);
        const chevron = document.getElementById('chevron-' + categoryId);

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(-90deg)';
        }
        updateToggleAllButton();
    }

    function toggleAllCategories() {
        const contents = document.querySelectorAll('[id^="cat-"]');
        const chevrons = document.querySelectorAll('[id^="chevron-"]');

        if (allCollapsed) {
            contents.forEach(c => c.classList.remove('hidden'));
            chevrons.forEach(c => c.style.transform = 'rotate(0deg)');
        } else {
            contents.forEach(c => c.classList.add('hidden'));
            chevrons.forEach(c => c.style.transform = 'rotate(-90deg)');
        }
        allCollapsed = !allCollapsed;
        updateToggleAllButton();
    }

    function updateToggleAllButton() {
        const contents = document.querySelectorAll('[id^="cat-"]');
        const hiddenCount = Array.from(contents).filter(c => c.classList.contains('hidden')).length;
        const toggleText = document.getElementById('toggle-all-text');
        const toggleIcon = document.getElementById('toggle-all-icon');

        if (hiddenCount === contents.length) {
            allCollapsed = true;
            toggleText.textContent = 'Fold ud';
            toggleIcon.setAttribute('data-lucide', 'chevrons-up');
        } else {
            allCollapsed = false;
            toggleText.textContent = 'Fold ind';
            toggleIcon.setAttribute('data-lucide', 'chevrons-down');
        }
        lucide.createIcons();
    }

    // === Section reordering (drag-and-drop) ===
    const DEFAULT_SECTION_ORDER = [
        'expenses-breakdown',
        'transfer-summary',
        'income-breakdown',
        'category-chart',
        'yearly-overview'
    ];

    function initSortableSections() {
        const container = document.getElementById('sortable-sections');
        if (!container) return;

        // Restore saved order
        const saved = localStorage.getItem('dashboardSectionOrder');
        if (saved) {
            try {
                const order = JSON.parse(saved);
                order.forEach(id => {
                    const el = container.querySelector(`[data-section-id="${id}"]`);
                    if (el) container.appendChild(el);
                });
            } catch (e) { /* ignore corrupt data */ }
        }

        // Initialize SortableJS
        Sortable.create(container, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'opacity-30',
            onEnd: function() {
                const order = Array.from(container.querySelectorAll('[data-section-id]'))
                    .map(el => el.dataset.sectionId);
                localStorage.setItem('dashboardSectionOrder', JSON.stringify(order));
                updateResetButton();
            }
        });

        updateResetButton();
    }

    function updateResetButton() {
        const container = document.getElementById('sortable-sections');
        const resetContainer = document.getElementById('reset-order-container');
        if (!container || !resetContainer) return;

        const currentOrder = Array.from(container.querySelectorAll('[data-section-id]'))
            .map(el => el.dataset.sectionId);
        const isDefault = JSON.stringify(currentOrder) === JSON.stringify(DEFAULT_SECTION_ORDER);
        resetContainer.classList.toggle('hidden', isDefault);
    }

    function resetSectionOrder() {
        localStorage.removeItem('dashboardSectionOrder');
        location.reload();
    }

    // === Restore saved preferences on load ===
    document.addEventListener('DOMContentLoaded', () => {
        // Restore period preference
        const savedPeriod = localStorage.getItem('budgetPeriod');
        if (savedPeriod === 'yearly') {
            setPeriod('yearly');
        }

        // Restore sort preference
        const savedSort = localStorage.getItem('categorySortOrder');
        if (savedSort) {
            const select = document.getElementById('category-sort');
            if (select) {
                select.value = savedSort;
                sortCategories(savedSort);
            }
        }

        // Initialize sortable sections
        initSortableSections();

        // Initialize charts
        initCharts();
    });

    // === Chart Visualization ===
    let categoryChart = null;

    // Color palette for charts (matches TailwindCSS colors)
    const chartColors = [
        '#3b82f6', // blue-500
        '#10b981', // emerald-500
        '#f59e0b', // amber-500
        '#ef4444', // red-500
        '#8b5cf6', // violet-500
        '#ec4899', // pink-500
        '#06b6d4', // cyan-500
        '#84cc16', // lime-500
    ];

    async function initCharts() {
        try {
            const response = await fetch('/budget/api/chart-data');
            if (!response.ok) return;

            const data = await response.json();
            renderCategoryChart(data.category_totals);
        } catch (error) {
            console.error('Failed to load chart data:', error);
        }
    }

    function renderCategoryChart(categoryTotals) {
        const ctx = document.getElementById('chart-categories');
        if (!ctx) return;

        const labels = Object.keys(categoryTotals);
        const values = Object.values(categoryTotals);
        const total = values.reduce((a, b) => a + b, 0);

        // Skip if no data
        if (total === 0) {
            ctx.parentElement.innerHTML = '<p class="text-gray-400 text-center py-8">Ingen data</p>';
            return;
        }

        if (categoryChart) categoryChart.destroy();

        categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: chartColors.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563',
                            padding: 12,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
