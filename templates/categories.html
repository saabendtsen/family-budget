{% extends "base.html" %}
{% set active_page = 'expenses' %}

{% block title %}Kategorier - Budget{% endblock %}

{% block content %}
<div class="max-w-md mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <a href="/budget/expenses" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 flex items-center gap-1 text-sm mb-1">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Tilbage til udgifter
            </a>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Kategorier</h1>
        </div>
        <button
            onclick="openAddModal()"
            class="bg-primary text-white p-3 rounded-xl shadow-lg hover:bg-blue-600 active:bg-blue-700 transition-colors"
        >
            <i data-lucide="plus" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Toast notification for updated expenses -->
    <div id="update-toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[70] bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2 text-sm max-w-sm">
        <i data-lucide="check-circle" class="w-5 h-5 flex-shrink-0"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Category list -->
    {% if categories %}
    <div class="space-y-3">
        {% for cat in categories %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                        <i data-lucide="{{ cat.icon }}" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">{{ cat.name }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            {% if category_usage[cat.name] > 0 %}
                            {{ category_usage[cat.name] }} udgift{{ 'er' if category_usage[cat.name] != 1 else '' }}
                            {% else %}
                            Ingen udgifter
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                <button
                    onclick="openEditModal({{ cat.id }}, '{{ cat.name }}', '{{ cat.icon }}', {{ category_usage[cat.name] }})"
                    class="flex-1 text-sm text-gray-600 dark:text-gray-400 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center gap-1"
                >
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                    Rediger
                </button>
                {% if category_usage[cat.name] == 0 %}
                <form method="post" action="/budget/categories/{{ cat.id }}/delete" class="flex-1">
                    <button
                        type="submit"
                        onclick="return confirm('Slet {{ cat.name }}?')"
                        class="w-full text-sm text-red-600 dark:text-red-400 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 flex items-center justify-center gap-1"
                    >
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Slet
                    </button>
                </form>
                {% else %}
                <div class="flex-1 text-sm text-gray-400 dark:text-gray-600 py-2 rounded-lg flex items-center justify-center gap-1 cursor-not-allowed" title="Kategorien er i brug">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                    I brug
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty state -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="folder" class="w-6 h-6 text-gray-400"></i>
        </div>
        <h3 class="font-medium text-gray-900 dark:text-white mb-1">Ingen kategorier</h3>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Tryk på + for at tilføje en kategori</p>
    </div>
    {% endif %}
</div>

<!-- Add/Edit Modal -->
<div id="modal" class="fixed inset-0 bg-black/50 flex items-end justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-2xl p-6 animate-slide-up">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white">Tilføj kategori</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form id="category-form" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Navn</label>
                <input
                    type="text"
                    name="name"
                    id="category-name"
                    placeholder="f.eks. Underholdning"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    required
                >
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ikon</label>
                <input type="hidden" name="icon" id="category-icon" value="folder" required>
                <button
                    type="button"
                    id="icon-picker-trigger"
                    onclick="openIconPicker()"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex items-center justify-between hover:border-gray-400 dark:hover:border-gray-500 transition-colors"
                >
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-600 rounded-lg flex items-center justify-center">
                            <i id="selected-icon-preview" data-lucide="folder" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <span id="selected-icon-name" class="text-gray-600 dark:text-gray-300">folder</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>

            <!-- Warning shown when editing a category that's in use -->
            <div id="edit-warning" class="hidden bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-3 text-sm text-amber-700 dark:text-amber-300 flex items-start gap-2">
                <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                <span id="edit-warning-text"></span>
            </div>

            <button
                type="submit"
                class="w-full bg-primary text-white py-4 rounded-xl font-medium hover:bg-blue-600 active:bg-blue-700 transition-colors flex items-center justify-center gap-2"
            >
                <i data-lucide="check" class="w-5 h-5"></i>
                <span id="submit-text">Tilføj</span>
            </button>
        </form>
    </div>
</div>

<!-- Icon Picker Modal -->
<div id="icon-picker-modal" class="fixed inset-0 bg-black/50 flex items-end justify-center z-[60] hidden">
    <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-2xl p-6 animate-slide-up max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Vælg ikon</h2>
            <button onclick="closeIconPicker()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Icon grid -->
        <div class="overflow-y-auto flex-1 -mx-2 px-2">
            <div class="grid grid-cols-5 gap-2" id="icon-grid">
                <!-- Icons will be rendered by JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Available icons curated for budget app
    const AVAILABLE_ICONS = [
        // Bolig
        'house', 'home', 'building', 'door-open', 'key',
        // Transport
        'car', 'bus', 'train', 'plane', 'bike', 'fuel',
        // Forbrug
        'zap', 'flame', 'droplet', 'wifi', 'thermometer',
        // Mad & Drikke
        'utensils', 'coffee', 'wine', 'shopping-cart', 'apple',
        // Familie
        'baby', 'users', 'heart', 'gift', 'cake',
        // Finans
        'piggy-bank', 'wallet', 'credit-card', 'coins', 'banknote',
        // Underholdning
        'tv', 'gamepad-2', 'music', 'film', 'headphones',
        // Sundhed
        'pill', 'activity', 'stethoscope', 'heart-pulse',
        // Sport & Fritid
        'dumbbell', 'bike', 'tent', 'mountain',
        // Uddannelse
        'graduation-cap', 'book', 'pencil', 'backpack',
        // Kommunikation
        'phone', 'smartphone', 'mail', 'message-circle',
        // Diverse
        'shield', 'briefcase', 'folder', 'tag', 'star',
        'gift', 'package', 'tool', 'wrench', 'scissors',
        'dog', 'cat', 'paw-print', 'flower-2', 'sun',
        'umbrella', 'cloud', 'calendar', 'clock', 'bell'
    ];

    const modal = document.getElementById('modal');
    const iconPickerModal = document.getElementById('icon-picker-modal');
    const form = document.getElementById('category-form');
    const modalTitle = document.getElementById('modal-title');
    const submitText = document.getElementById('submit-text');
    const iconGrid = document.getElementById('icon-grid');

    // Render icon grid
    function renderIconGrid() {
        iconGrid.innerHTML = AVAILABLE_ICONS.map(icon => `
            <button
                type="button"
                onclick="selectIcon('${icon}')"
                class="icon-option aspect-square flex items-center justify-center rounded-xl border-2 border-transparent hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors p-3"
                data-icon="${icon}"
                title="${icon}"
            >
                <i data-lucide="${icon}" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
            </button>
        `).join('');
        lucide.createIcons();
    }

    function updateSelectedIcon(iconName) {
        document.getElementById('category-icon').value = iconName;
        document.getElementById('selected-icon-name').textContent = iconName;

        // Update preview icon
        const previewEl = document.getElementById('selected-icon-preview');
        previewEl.setAttribute('data-lucide', iconName);
        lucide.createIcons();

        // Highlight selected icon in grid
        document.querySelectorAll('.icon-option').forEach(btn => {
            if (btn.dataset.icon === iconName) {
                btn.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900/30');
            } else {
                btn.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/30');
            }
        });
    }

    function selectIcon(iconName) {
        updateSelectedIcon(iconName);
        closeIconPicker();
    }

    function openIconPicker() {
        renderIconGrid();
        const currentIcon = document.getElementById('category-icon').value;
        updateSelectedIcon(currentIcon);
        iconPickerModal.classList.remove('hidden');
    }

    function closeIconPicker() {
        iconPickerModal.classList.add('hidden');
    }

    function openAddModal() {
        form.action = '/budget/categories/add';
        modalTitle.textContent = 'Tilføj kategori';
        submitText.textContent = 'Tilføj';
        document.getElementById('category-name').value = '';
        document.getElementById('edit-warning').classList.add('hidden');
        updateSelectedIcon('folder');
        modal.classList.remove('hidden');
        lucide.createIcons();
    }

    function openEditModal(id, name, icon, usage) {
        form.action = '/budget/categories/' + id + '/edit';
        modalTitle.textContent = 'Rediger kategori';
        submitText.textContent = 'Gem';
        document.getElementById('category-name').value = name;

        const warning = document.getElementById('edit-warning');
        if (usage > 0) {
            document.getElementById('edit-warning-text').textContent =
                'Denne kategori bruges i ' + usage + ' udgift' + (usage !== 1 ? 'er' : '') + ' \u2013 de opdateres automatisk.';
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }

        updateSelectedIcon(icon);
        modal.classList.remove('hidden');
        lucide.createIcons();
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    // Close modals on backdrop click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    iconPickerModal.addEventListener('click', (e) => {
        if (e.target === iconPickerModal) closeIconPicker();
    });

    // Close modals on escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (!iconPickerModal.classList.contains('hidden')) {
                closeIconPicker();
            } else {
                closeModal();
            }
        }
    });

    // Show toast if expenses were updated after category rename
    (function() {
        const params = new URLSearchParams(window.location.search);
        const updated = params.get('updated');
        if (updated) {
            const count = parseInt(updated, 10);
            const toast = document.getElementById('update-toast');
            const msg = document.getElementById('toast-message');
            msg.textContent = 'Kategori opdateret. ' + count + ' udgift' + (count !== 1 ? 'er' : '') + ' blev også opdateret.';
            toast.classList.remove('hidden');
            lucide.createIcons();
            // Remove query param from URL without reload
            window.history.replaceState({}, '', window.location.pathname);
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }
    })();
</script>
{% endblock %}
